<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Loja Afiliados — JSON</title>
<style>
:root{--bg:#ffffff;--text:#111;--card:#fff;--muted:#777;--accent:#008cff}
.dark{--bg:#0b0b0b;--text:#eaeaea;--card:#121212;--muted:#9b9b9b;--accent:#00aaff}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text)}
header{display:flex;gap:10px;align-items:center;padding:18px;border-bottom:1px solid rgba(0,0,0,0.06);flex-wrap:wrap}
.brand{font-weight:700}
.controls{display:flex;gap:10px;flex:1}
.controls input{flex:1;padding:10px;border-radius:10px;border:1px solid #ddd}
.controls select{padding:10px;border-radius:10px;border:1px solid #ddd}
.btn{background:var(--accent);color:#fff;padding:10px;border-radius:10px;border:0;cursor:pointer}
main{padding:20px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:18px}
.card{background:var(--card);padding:12px;border-radius:12px;display:flex;flex-direction:column;gap:10px;min-height:300px;box-shadow:0 6px 18px rgba(16,24,40,0.06)}
.thumb{width:100%;height:180px;object-fit:cover;border-radius:10px;background:#eee}
.price-row{display:flex;justify-content:space-between;align-items:center}
.preco{font-weight:700}
.muted{color:var(--muted)}
.footer{padding:18px;text-align:center;color:var(--muted)}
</style>
</head>
<body>
<header>
  <div class="brand">Loja Afiliados</div>
  <div class="controls">
    <input id="q" placeholder="Pesquisar..." oninput="filtrar()">
    <select id="categoria" onchange="filtrar()"><option value="">Todas categorias</option></select>
    <select id="ordenar" onchange="filtrar()"><option value="">Ordenar</option><option value="menor">Menor preço</option><option value="maior">Maior preço</option></select>
  </div>
  <div class="actions"><button class="btn" onclick="toggleTema()">Claro/Escuro</button></div>
</header>
<main>
  <div id="lista" class="grid">Carregando produtos...</div>
</main>
<div class="foote"</div>

<script>
// === CONFIGURAR ===
const API_BASE = 'httb Pages. Defina <code>API_BASE</code> com sua URL da Vercel.</div>

<script>
// === CONFIGURAR ===
const API_BASE = 'https://SEU-USUARIO.vercel.app/api/preco'; // Trocar pela sua URL da Vercel
// ==================

async function fetchJSON(path){
  const r = await fetch(path);
  if(!r.ok) throw new Error('Erro ao carregar ' + path);
  return r.json();
}

let produtos = [];

async function carregar(){
  try{
    produtos = await fetchJSON('produtos.json');
  }catch(e){
    document.getElementById('lista').innerHTML = '<p style="padding:20px">Não encontrei produtos.json.</p>';
    console.error(e); return;
  }

  // popular categorias
  const cats = Array.from(new Set(produtos.map(p=>p.categoria).filter(Boolean)));
  const sel = document.getElementById('categoria');
  cats.forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent=capitalize(c);sel.appendChild(o)});

  await render(produtos);
}

function capitalize(s){return s? s.charAt(0).toUpperCase()+s.slice(1):''}

async function render(list){
  const root = document.getElementById('lista'); root.innerHTML='';
  // mostra placeholders e busca preço em batches para não sobrecarregar
  const batch = 6;
  for(let i=0;i<list.length;i+=batch){
    const slice = list.slice(i,i+batch);
    // criar elementos
    slice.forEach(p=> root.appendChild(makeCard(p)) );
    // buscar preços do slice em paralelo
    await Promise.all(slice.map(async p=>{
      const preco = await pegarPreco(p);
      const el = document.querySelector(`.card[data-id="${p.id}"] .preco`);
      if(el) el.textContent = preco || 'Preço indisponível';
    }));
  }
}

function makeCard(p){
  const el = document.createElement('div'); 
  el.className='card'; 
  el.setAttribute('data-id',p.id);
  el.setAttribute('data-nome',(p.nome||'').toLowerCase()); 
  el.setAttribute('data-cat',p.categoria||'');

  el.innerHTML = `
    <img class="thumb" src="img/${p.img || 'placeholder.png'}" alt="${escape(p.nome)}">
    <div>
      <h3>${escape(p.nome)}</h3>
      <div class="muted">${escape(p.origem||'')}</div>
      <div class="price-row">
        <div class="preco">Carregando...</div>
        <a class="btn" style="text-decoration:none; padding:8px 10px; background:var(--accent)" href="${p.link||'#'}" target="_blank">Comprar</a>
      </div>
    </div>
  `;
  return el;
}

function escape(s){return s? String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') : ''}

async function pegarPreco(p){
  if(!API_BASE || API_BASE.includes('SEU-USUARIO')) return p.preco || null; // se não configurado, usa o preco do JSON
  try{
    const url = new URL(API_BASE);
    url.searchParams.set('id', p.id);
    url.searchParams.set('origem', p.origem);
    if(p.shopid) url.searchParams.set('shopid', p.shopid);
    const r = await fetch(url.toString());
    if(!r.ok) throw new Error('API erro');
    const j = await r.json();
    return j.preco || null;
  }catch(e){console.error('pegarPreco',e);return null}
}

function filtrar(){
  const q = (document.getElementById('q').value||'').toLowerCase();
  const cat = document.getElementById('categoria').value;
  const ord = document.getElementById('ordenar').value;
  let cards = Array.from(document.querySelectorAll('.card'));
  cards.forEach(c=>{
    const nome = c.dataset.nome||''; const categoria = c.dataset.cat||'';
    c.style.display = ( (nome.includes(q)||q==='') && (cat===''||cat===categoria) )? 'flex':'none';
  });
  if(ord==='menor' || ord==='maior'){
    const vis = cards.filter(c=>c.style.display!=='none');
    const val = el=>{ const t = el.querySelector('.preco')?.textContent||''; const n = parseFloat(t.replace(/[R$\s.]/g,'').replace(',','.')); return isNaN(n)?(ord==='menor'?999999:-1):n };
    vis.sort((a,b)=> ord==='menor'? val(a)-val(b) : val(b)-val(a));
    const root = document.getElementById('lista'); vis.forEach(v=> root.appendChild(v));
  }
}

function toggleTema(){ document.body.classList.toggle('dark') }

carregar();
</script>
</body>
</html>

